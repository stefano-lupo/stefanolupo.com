<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Stefano Lupo Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Stefano Lupo Tech">
<meta property="og:url" content="http://stefanolupo.tech/blog/index.html">
<meta property="og:site_name" content="Stefano Lupo Tech">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stefano Lupo Tech">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Stefano Lupo Tech</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">Programming, tech and other interesting things.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="http://stefanolupo.tech">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://stefanolupo.tech/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="page-Airport-Web-Sockets" class="article article-type-page" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/09/19/Airport-Web-Sockets/" class="article-date">
  <time datetime="2017-09-19T14:37:15.000Z" itemprop="datePublished">19-09-2017</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Web-Programming/">Web Programming</a>
  </div>

  </div>
  <div class="article-inner">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/websocket-chat-server/chatroom.png" rel="gallery_cj809gjb40001rjqdqct9lodo">
        <img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/websocket-chat-server/chatroom.png" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/09/19/Airport-Web-Sockets/">Airport WebSockets</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>So I was just about to board my flight to Amsterdam when we were informed that the flight was to be delayed by three hours (guess what airline I was flying with..). I started thinking of things to do to kill the time, but had decided not to bring my laptop with me. Fortunately however I have my router port forwarded so I have ssh access to my Raspberry Pi (which I leave on 24/7 since it uses a whole 1.2 Watts) from anywhere I have an internet connection. So I pulled out my phone and fired up JuiceSSH and started thinking what I could do..</p>
<h2 id="What-Are-WebSockets"><a href="#What-Are-WebSockets" class="headerlink" title="What Are WebSockets?"></a>What Are WebSockets?</h2><p>I had done some socket programming before (mainly writing a simple HTTP/HTTPS Proxy Server in Java  - <a href="https://github.com/stefano-lupo/Java-Proxy-Server" target="_blank" rel="external">GitHub Repo</a>) but I had heard the buzz word <em>WebSockets</em> being thrown around a lot lately so I decided to check it out. I had a rough idea of what to expect but a quick google gave me a nice succint description: </p>
<blockquote>
<p>“WebSockets represent a long awaited evolution in client/server web technology. They allow a long-held single TCP socket connection to be established between the client and server which allows for bi-directional, full duplex, messages to be instantly distributed with little overhead resulting in a very low latency connection.” - <em>from <a href="https://pusher.com/websockets" target="_blank" rel="external">pusher.com</a></em></p>
</blockquote>
<p>The first things that come to mind when reading that description are real-time applications such as video games and chat. Since I only had two hours (and was developing over SSH on my phone), I decided on the latter. Another quick google search provided a <a href="http://codular.com/node-web-sockets" target="_blank" rel="external">great blog post</a> on setting up a simple chat server with WebSockets.</p>
<h2 id="Getting-the-Required-Tools"><a href="#Getting-the-Required-Tools" class="headerlink" title="Getting the Required Tools"></a>Getting the Required Tools</h2><p>The first thing to do was to obtain a WebSocket library for node. There are a bunch of WebSocket implementations and im sure most are great, but the I went for was <em>websocket-node</em>. The first thing to do was to make a directory to hold my project. As I knew there would be server side and client side code, I made two seperate directories - <em>public</em> for client side code and <em>server</em> for server side code.</p>
<p>A quick note here - as we need to serve up the client side code (through a browser in my case), we need some extra functionality to do this for us. As I am a web developer I already had the LAMP stack set up on my machines at home (<a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-16-04" target="_blank" rel="external">this is a great article</a> on how to set this up if you haven’t already). The LAMP stack is an extremely common and easy way to serve up static websites and is most likely what was used if you have ever paid for web hosting. Another great option if you would like to stick with Node is Express. I probably would have went with this had I not already had a way to serve web pages set up. </p>
<p>I set up a new virtual host for my WebSocket chat server (<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-virtual-hosts-on-ubuntu-14-04-lts" target="_blank" rel="external">see here</a>) and proceeded to create the directories to hold my chat server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Note you may need sudo here depending on how you have set up your permissions</div><div class="line">$ mkdir /var/www/websockets/public /var/www/websockets/server -p</div></pre></td></tr></table></figure>
<p>The <em>-p</em> flag for mkdir is a handy one which will create any directories that do not exist along the way, saving you from typing multiple mkdir commands. </p>
<p>Next I created a package.json file in my server directory (as this will be written in node, but the client side code will not).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd /var/www/websockets/server</div><div class="line">$ npm init</div></pre></td></tr></table></figure>
<p>Follow along in the initialization process to create your <em>package.json</em> file (although what you actually type has little importance). Finally install <em>websocket-node</em> using the following: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Again, either use sudo, or chown the websockets directory</div><div class="line">$ npm install websocket --save</div></pre></td></tr></table></figure>
<h1 id="Creating-the-WebSocket-Chat-Server"><a href="#Creating-the-WebSocket-Chat-Server" class="headerlink" title="Creating the WebSocket Chat Server"></a>Creating the WebSocket Chat Server</h1><h2 id="Server-Side-Code"><a href="#Server-Side-Code" class="headerlink" title="Server Side Code"></a>Server Side Code</h2><p>Finally it was time to write some code. I decided to work on the server side code first. The first step is to set up a standard Node HTTP server.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var http = require(&apos;http&apos;);</div><div class="line">var server = http.createServer(function (request, response) &#123;&#125;);</div></pre></td></tr></table></figure></p>
<p>Next we need to specify a free port on which the server can listen. I picked 3000 as I had already portforwarded that port to my Raspberry Pi on my router. Portforwarding allows your router to forward incoming packets at the specified port, to a specified machine on your local network. It looks something like this:</p>
<p><strong><em>http://&lt;Router’s IP&gt;:3000    —&gt;    Router    —&gt;    Server on Raspberry Pi Listening on port 3000</em></strong></p>
<p>Since I had port forwarded port 3000 to point to my Raspberry Pi, the router then forwards those packets onto my Raspberry Pi allowing my server to be connected to from outside of my local network.</p>
<p>So telling our HTTP server to listen on port 3000:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server.listen(3000, function () &#123;</div><div class="line">    console.log(&apos;Server is listening on port 3000&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Next we can create a WebSocket Server and connect it up to our HTTP server by passing the HTTP server to the constructor. This <code>WebSocket</code> is what gives us our long held client-server connection, as opposed to standard HTTP which requires a fresh HTTP request everytime we wish to update.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var WebSocketServer = require(&apos;websocket&apos;).server;</div><div class="line">wsServer = new WebSocketServer(&#123; httpServer: server &#125;);</div></pre></td></tr></table></figure>
<p>Next we need some way of keeping track of our clients and the messages that have been sent. As I was just doing this for fun I didn’t implement anything fancy for storing the messages (no not even file IO - but I was doing this from my phone after all…). I ended up just storing the messages in an array which obviously isn’t a good idea, but it works in the short term.</p>
<p>So we need three variables, one to use as clients IDs, a Map to hold our clients which can be indexed by the ID and an array of sent messages.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var id = 0;</div><div class="line">var clients = new Map();</div><div class="line">var messages = [];</div></pre></td></tr></table></figure>
<p>Next we define the callback to executed when a client attempts to connect to the server. Upon receiving a request, we have the option to accept or reject the client. All are welcome on my chat server so I just accepted any incoming connections. I assign the new client the next ID and increment the ID so it’s ready for the next client, add the client to our clients Map and log out a small message to the terminal so we can see when clients have joined. Finally we will send all the old messages to the newly connected client. Note that the sendUTF method obviously only works with strings, but since were using JSON, a simple <code>JSON.stringify()</code> takes care of that and the data can be recovered using <code>JSON.parse()</code> on the other side.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">wsServer.on(&apos;request&apos;, function (request) &#123;</div><div class="line">    // Envoked when client connects, send them all previous messages</div><div class="line">    var connection = request.accept(&apos;echo-protocol&apos;, request.origin);</div><div class="line">    connection.id = id++;</div><div class="line">    clients.set(id, connection);</div><div class="line">    console.log((new Date()) + &apos; Connection accepted [&apos; + connection.id + &apos;]&apos;);</div><div class="line"></div><div class="line">    // Send old messages to client</div><div class="line">    connection.sendUTF(JSON.stringify(messages));</div><div class="line"></div><div class="line">    // More code to go here soon..</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Finally we need to define a couple more callbacks for when a client sends a message (or rather, when the server receives a message) and when the client disconnects. WebSockets make this really simple with the <code>on(&#39;message&#39;, callback)</code> and <code>on(&#39;close&#39;, callback)</code> respectively. Upon (the server) receiving a message, we want to save the message and broadcast that message to all connected clients. Ideally, we wouldn’t send this back to client who sent it and just update the sender’s client side messages, but as this was just a quick implementation, I went with the simpler route of just having the message broadcast to and picked up by all clients (including the sender). </p>
<p>Finally when a client disconnects, we free up the resources they were using and remove them from our clients Map so that we don’t try to send any more messages to that connection. This is why we used a Map, so that the client with the appropriate ID can be deleted.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">wsServer.on(&apos;request&apos;, function (request) &#123;</div><div class="line">    // ....Previous code</div><div class="line"></div><div class="line">    // Envoked when a message is sent</div><div class="line">    connection.on(&apos;message&apos;, function (message) &#123;</div><div class="line">        var msgString = message.utf8Data;</div><div class="line">        messages.push(msgString);</div><div class="line">        sendToAllClients(msgString);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    // Envoked when client disconnects</div><div class="line">    connection.on(&apos;close&apos;, function (reasonCode, description) &#123;</div><div class="line">        clients.delete(connection.id);</div><div class="line">        console.log((new Date()) + &apos; Peer &apos; + connection.remoteAddress + &apos; disconnected.&apos;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The last thing to do on the server side code is to define our <code>sendToAllClients(message)</code> function. Since we have a Map containing all of our clients and a function <code>sendUTF(message)</code> to send a message to a client, this is really simple.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// Note this is outside of the on request received function body</div><div class="line">function sendToAllClients(message) &#123;</div><div class="line">    clients.forEach(function(client) &#123;</div><div class="line">        client.sendUTF(message);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Client-Side-Code"><a href="#Client-Side-Code" class="headerlink" title="Client Side Code"></a>Client Side Code</h2><p>Now that the server is all set up its time to create the web page for the chat room. I wrote this using basic HTML, CSS, Bootstrap and jQuery. First head back to the root of our project, cd into our public folder and make two files - <em>index.html</em> and <em>script.js</em>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /var/www/websockets/public</div><div class="line">touch index.html script.js</div></pre></td></tr></table></figure>
<p>I started out with the markup to create the interface. It consists of two <code>&lt;form&gt;</code>s (one for signing up for the chat room and one for sending messages) and a <code>&lt;ul&gt;</code> to which we will programatically add <code>&lt;li&gt;</code>s as we receive messages.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;div class=&quot;container-fluid&quot;&gt;</div><div class="line">    &lt;h1 class=&quot;text-center&quot;&gt;The Worlds Worst Chat Room &lt;/h1&gt;</div><div class="line">    &lt;hr&gt;</div><div class="line"></div><div class="line">    &lt;h2&gt;Join The Chat Room&lt;/h2&gt;</div><div class="line">    &lt;form id=&quot;join&quot;&gt;</div><div class="line">        &lt;input required placeholder=&quot;Enter your name&quot; id=&quot;name&quot; name=&quot;name&quot; /&gt;</div><div class="line">        &lt;input required placeholder=&quot;Avatar URL&quot; id=&quot;avatar&quot; name=&quot;avatar&quot; /&gt;</div><div class="line">        &lt;button class=&quot;btn btn-primary&quot; type=&quot;submit&quot; name=&quot;join_button&quot; id=&quot;join_button&quot;&gt;Join&lt;/button&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line"></div><div class="line">    &lt;h1&gt;Chat&lt;/h1&gt;</div><div class="line">    &lt;div id=&quot;chat-div&quot;&gt;</div><div class="line">        &lt;ul id=&quot;chatlog&quot;&gt;&lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  </div><div class="line">    &lt;form id=&quot;send&quot;&gt;</div><div class="line">        &lt;textarea rows=&quot;4&quot; cols=&quot;50&quot; required disabled name=&quot;message&quot; id=&quot;message&quot; placeholder=&quot;Send a message&quot;&gt;&lt;/textarea&gt;</div><div class="line">        &lt;button class=&quot;btn btn-danger disabled&quot; type=&quot;submit&quot; id=&quot;send-button&quot;&gt;Send!&lt;/button&gt;</div><div class="line">    &lt;/form&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>Finally I added some styling, grabbed CDNs for Bootstrap and jQuery and included our script.js file.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;script src=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js&quot;/&gt;</div><div class="line">&lt;script src=&quot;script.js&quot;&gt;&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;link href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u&quot; crossorigin=&quot;anonymous&quot;&gt;</div><div class="line">&lt;style&gt;</div><div class="line">    #chat-div &#123;</div><div class="line">        border: solid black 1px;</div><div class="line">        height:350px; </div><div class="line">        overflow:auto;</div><div class="line">        -webkit-box-shadow: 5px 5px 34px -10px rgba(0,0,0,0.75);</div><div class="line">        -moz-box-shadow: 5px 5px 34px -10px rgba(0,0,0,0.75);</div><div class="line">        box-shadow: 5px 5px 34px -10px rgba(0,0,0,0.75);</div><div class="line">    &#125;</div><div class="line">    #chatlog &#123;</div><div class="line">        list-style-type:none; </div><div class="line">    </div><div class="line">    &#125;</div><div class="line">    hr &#123;</div><div class="line">        margin-top: 5px;</div><div class="line">        margin-bottom: 5px;</div><div class="line">    &#125;</div><div class="line">    h4 &#123;</div><div class="line">        display: inline</div><div class="line">    &#125;</div><div class="line">    #avatar-pic &#123;</div><div class="line">        width: 50px;</div><div class="line">        border-radius: 50%;</div><div class="line">        border: solid rgba(0,0,0,0.6) 1px;</div><div class="line">        margin: 5px;</div><div class="line">    &#125;</div><div class="line">    #date-string &#123;</div><div class="line">        text-align: right;</div><div class="line">        float:right;</div><div class="line">    &#125;</div><div class="line">    #message-li &#123;</div><div class="line">        padding:5px 0px 5px 0px</div><div class="line">    &#125;</div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure></p>
<p>The last thing we have to do is to connect up our client side code to our server and set up some logic in jQuery to handle the client joining the chat room and sending messages. Once the client submits the join form, we will save their inputted credentials and connect to the server. This is really easy with WebSockets, simply create a <code>new WebSocket</code> instance that points to our server. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">// Ensure document is defined (page is fully loaded)</div><div class="line">$(document).ready(function () &#123;</div><div class="line">    var ws;</div><div class="line">    var name, avatar;</div><div class="line"></div><div class="line">    // Allow the client to join the server </div><div class="line">    $(&quot;#join&quot;).submit(function( event ) &#123;</div><div class="line">        event.preventDefault();</div><div class="line"></div><div class="line">        // Save credentials</div><div class="line">        name = $(&quot;#name&quot;).val();</div><div class="line">        avatar = $(&quot;#avatar&quot;).val();</div><div class="line">      </div><div class="line">        // Connnect to Server</div><div class="line">        ws =  new WebSocket(&apos;ws://&lt;server&gt;:&lt;port&gt;&apos;, &apos;echo-protocol&apos;);</div><div class="line"></div><div class="line">        // More code to go here..</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>We need to define a couple of callbacks in order to get the functionality we want. <code>onopen</code> allows us to define a callback function that will be executed when we successfully connect to the server. I wanted to announce when a new client joined the chatroom, so in the body of the <code>onopen</code> callback I created a new message object and sent that off to the server. I also enabled the <code>&lt;textarea&gt;</code> field which is used for inputing the user’s message and the submit <code>&lt;button&gt;</code> which is used for sending the message. Until this point they were both disabled as I didn’t want users attempting to send messages prior to connecting to the server.</p>
<p>We also need an event listener to handle receiving messages from the server. Once messages are received from the server, we want to create <code>&lt;li&gt;</code>s to hold the new messages. For clarity we will define this function later, so the callback just needs to call this function for each new message that is received (or array of messages in the case of the server sending the array of past messages when the client connects).<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$(&quot;#join&quot;).submit(function( event ) &#123;</div><div class="line"></div><div class="line">    // ...Previous code</div><div class="line"></div><div class="line">    // Send &quot;client&quot; joined chatroom messgae  </div><div class="line">    ws.onopen = function() &#123;</div><div class="line">        var message = &#123;</div><div class="line">            name: name,</div><div class="line">            avatar: avatar,</div><div class="line">            message: &quot;joined the chatroom.&quot;,</div><div class="line">            date: new Date()</div><div class="line">        &#125;</div><div class="line">        ws.send(JSON.stringify(message));</div><div class="line"></div><div class="line">        // Allow client to send messages</div><div class="line">        $(&quot;#message&quot;).prop(&apos;disabled&apos;, false);</div><div class="line">        $(&quot;#send-button&quot;).removeClass(&quot;disabled btn-danger&quot;).addClass(&quot;btn-success&quot;);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    // Add Listener for receiving messages</div><div class="line">    ws.addEventListener(&quot;message&quot;, function (e) &#123;</div><div class="line">        var msg = JSON.parse(e.data);</div><div class="line"></div><div class="line">        // Server sends an array of passed messages to client upon joining</div><div class="line">        if(Array.isArray(msg)) &#123;</div><div class="line">            msg.forEach(function (message) &#123;</div><div class="line">                addMessage(JSON.parse(message));   </div><div class="line">            &#125;);</div><div class="line">        &#125; else &#123;</div><div class="line">            addMessage(msg);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Scroll to bottom of chat div to keep up with current messages</div><div class="line">        $(&apos;#chat-div&apos;).scrollTop($(&apos;#chat-div&apos;)[0].scrollHeight);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Next we need a listener for sending messages to the server. This callback simply creates a message obejct, sends it on to the server and and clears the message <code>&lt;textarea&gt;</code> in preperation for the next message.</p>
<p>Finally we define the <code>addMessage(message)</code> function. We make use of jQuery’s <code>append(markup)</code> method in order to append a list item to the unordered list which holds our messages. Theres some extra bits and pieces in the markup to display the sender’s name, avatar and the timestamp.</p>
<pre><code>// Add listener for sending messages
$(&quot;#send&quot;).submit(function( event ) {
    event.preventDefault();

    // Package up the message object
    var message = {
        name: name,
        avatar: avatar,
        message: $(&quot;#message&quot;).val(),
        date: new Date()
    }

    // Clear the message input field once the message has been sent 
    $(&quot;#message&quot;).val(&apos;&apos;);

    // Send the message object (serialized as a string)
    ws.send(JSON.stringify(message));
});  

// Some markup for the messages
function addMessage(message) {
    $(&quot;#chatlog&quot;).append(&apos;&lt;li id=&quot;message-li&quot;&gt;&apos;
        + &apos;&lt;div&gt;&lt;img id=&quot;avatar-pic&quot; src=&quot;&apos;
        + &quot;  &quot; + message.avatar + &apos;&quot;&gt;&apos; 
        + &quot;&lt;h4&gt;&quot; + message.name + &quot;&lt;/h4&gt;&quot;
        + &apos;&lt;p id=&quot;date-string&quot;&gt;&apos; + new Date(message.date).toLocaleTimeString() + &quot;&lt;/p&gt;&lt;/div&gt;&quot; 
        + message.message 
        + &quot;&lt;hr&gt;&quot;   
        + &quot;&lt;/li&gt;&quot;
    );
}
</code></pre><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>And with that we’re all set. Run the server code with <code>node server/index.js</code> from the root of our project directory and browse to your IP address (or localhost if you’re developing locally) and give it a go!</p>
<p>The full source code is available <a href="https://github.com/stefano-lupo/websocket-chat-server" target="_blank" rel="external">here on GitHub</a>. Thanks for reading.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://stefanolupo.tech/blog/2017/09/19/Airport-Web-Sockets/" data-id="cj809gjb40001rjqdqct9lodo" class="article-share-link">Share</a>
      
        <a href="http://stefanolupo.tech/blog/2017/09/19/Airport-Web-Sockets/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebSockets-Node-Javascript-SSH-Raspberry-Pi/">WebSockets Node Javascript SSH Raspberry Pi</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="page-hexagonPatioTable" class="article article-type-page" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/09/02/hexagonPatioTable/" class="article-date">
  <time datetime="2017-09-02T17:56:28.000Z" itemprop="datePublished">02-09-2017</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Woodworking/">Woodworking</a>
  </div>

  </div>
  <div class="article-inner">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170610_180608.jpg" rel="gallery_cj809gjay0000rjqdms6r7sg3">
        <img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170610_180608.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2017/09/02/hexagonPatioTable/">Octagonal Patio Table</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>So back at the start of summer just as I was finishing my exams, I was snooping around my house looking for something that was old / damaged that I knew would be annoying my Mum. After about a month straight of studying (and writing way more ARM Assembly than one should ever have to) I really wanted to build something. Also at this point I had spent all my money on tools and hadn’t yet <em>built</em> anything with them (hence me looking for a project that my mum would <del>fund</del> be interested in),  so was feeling a bit dumb at this stage. </p>
<p>I finally looked out the back and realised our patio table was pretty destroyed after sitting out in Irish weather for about 8 years. </p>
<p><img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170902_181553.jpg" alt="Gross Old Patio Table"></p>
<p>So I decided that this would be a fun big project and one that would be quite useful for the summer. My family suggested refinishing it which I quickly rejected due to all that sanding (and besides the wood was starting to rot anyway) and decided to build a new one.</p>
<h1 id="Steve-Ramsey’s-Octagonal-Patio-Table"><a href="#Steve-Ramsey’s-Octagonal-Patio-Table" class="headerlink" title="Steve Ramsey’s Octagonal Patio Table"></a>Steve Ramsey’s Octagonal Patio Table</h1><p>Luckily for me tonnes of people have posted videos about every topic conceivable on YouTube, so I started there. I came accross a <a href="https://www.youtube.com/watch?v=DPIfzyXd9Hg" target="_blank" rel="external">Steve Ramsey video</a> (who by the way is a great You Tuber who makes woodworking accessible for everyone) and decided to go for his cool octagonal patio table design.</p>
<p>The first thing I did was figure out how to make an octagon which is pretty easy: </p>
<blockquote>
<p>360 degrees / 8 sides = 45 degrees / 2 cuts join together = 22.5 degrees</p>
</blockquote>
<p>This means that each segment of the octagon needs a 22.5 degree mitre on both ends, so that when two adjacent segments are joined together the resulting angle is 45 degrees. Im <strong>really</strong> bad at visualizing things (as was confirmed in every aptitude test I’ve ever taken - probably why Im a computer engineer..) so I had to make a little mini test octagon, but I also didnt want to cut 8 pieces to make a test octagon so I cut two pieces. I could then place the two down and trace them with chalk, move one piece to act as the next segment, trace the newly added piece and repeat. This traced me out a nice octagon so I was happy that my angles / mitre setup was correct.</p>
<p>I went ahead and cut 8 pieces (at 90 degreees) to the <strong>long</strong> dimension. Once I knew these were all the same, I could set up my mitre gauge to make a 22.5 degree cut and cut each piece such that the long side wouldn’t be shortened at all, resulting in 8 pieces with the same long side length and same angle - so 8 identical pieces. I laid the 8 pieces out and I had a pretty nice fitting octagon!</p>
<p><img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170528_163314.jpg" alt="The Octagon and &quot; Chalk Test for Idiots&trade; &quot;"></p>
<p>I cut a rabbet on the insde of all 8 pieces to accept the 4x1 pieces that would make up the actual table top, glued and pocket screwed all the 8 pieces together and had a solid octagon!</p>
<p>I then got to work cutting and fitting the 4x1s to span the width of the octagon and make up the table top. Most of these cuts were simple 90 or 45 degree cuts but four of them (one on each of the ends of two of the pieces) were a little messier as part of the cut had to be 90 degrees and the other part 45 degrees. This wasn’t too bad though, I just cut them square at their full length and then snook up (reallllyy slowly) on the 45 degree cut until the piece slotted in. This makes more sense with a picture.</p>
<p> <img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170610_180451.jpg" alt="Partial 45 degree cut"></p>
<h1 id="The-Legs"><a href="#The-Legs" class="headerlink" title="The Legs"></a>The Legs</h1><p> I followed Steve Ramsey’s plans again here and attached the legs together using two cross pieces joined using half laps. I pocket screwed the bottom cross braces into the legs from underneath so they were out of sight. However for the top cross brace, I cut a rabbet onto each of the four ends of the cross so that the octagon could sit on top of the rabbet. This meant the top was now connected to the upper cross piece and I finally connected this assembly to each of the four legs with screws through the front of the legs and capped them with dowels so they wouldn’t be noticable (which you <em>just</em> see at the top of the leg in the following image).</p>
<p> <img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170530_201330.jpg" alt="The (almost) Assembled Table"></p>
<p> And yes I ran out of 4x1 at this point so had to wait till the next day to put in the final pieces.<br> One thing that irritates me about this table is the last pieces of the table top being really skinny - you can see the slot for the last piece of the top on the left in the previous picture.</p>
<h1 id="The-Finished-Table"><a href="#The-Finished-Table" class="headerlink" title="The Finished Table"></a>The Finished Table</h1><p> All that was left to do was to apply a finish. I really liked the ‘whiteness’ (or lack of yellowness) of unfinished pine and have had projects in past look awful due to how yellow the pine went after varnishing. Luckily I found this <a href="http://www.ronseal.co.uk/home/exterior-doors-and-windows/outdoor-varnish/" target="_blank" rel="external">Ronseal Outdoor Varnish</a> that apparently “doesn’t yellow like traditional varnish” and after applying 4 coats was happy it with how little it yellowed. To be honest it could have used a few more coats but I was so sick of varnishing that I decided I’d rather build a new patio table next year than do any more varnishing.</p>
<p><img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170610_180431.jpg" alt="The Finished Table">  </p>
<p><img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/patio-table/20170610_180521.jpg" alt="The Underside"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://stefanolupo.tech/blog/2017/09/02/hexagonPatioTable/" data-id="cj809gjay0000rjqdms6r7sg3" class="article-share-link">Share</a>
      
        <a href="http://stefanolupo.tech/blog/2017/09/02/hexagonPatioTable/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Woodworking-Octagonal-Patio-Table-DIY-Steve-Ramsey/">Woodworking Octagonal Patio Table DIY Steve Ramsey</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Web-Programming/">Web Programming</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Woodworking/">Woodworking</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2017/09/19/Airport-Web-Sockets/">Airport WebSockets</a>
          </li>
        
          <li>
            <a href="/blog/2017/09/02/hexagonPatioTable/">Octagonal Patio Table</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Stefano Lupo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="http://stefanolupo.tech" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'stefanolupo-tech';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>

  </div>
</body>
</html>