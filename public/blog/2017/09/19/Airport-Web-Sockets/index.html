<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>WebSocket Chat Room | Stefano Lupo Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="So I was just about to board my flight to Amsterdam when we were informed that the flight was to be delayed by three hours (guess what airline I was flying with..). I started thinking of things to do">
<meta name="keywords" content="WebSockets Node Javascript SSH Raspberry Pi">
<meta property="og:type" content="article">
<meta property="og:title" content="WebSocket Chat Room">
<meta property="og:url" content="http://stefanolupo.com/blog/2017/09/19/Airport-Web-Sockets/index.html">
<meta property="og:site_name" content="Stefano Lupo Tech">
<meta property="og:description" content="So I was just about to board my flight to Amsterdam when we were informed that the flight was to be delayed by three hours (guess what airline I was flying with..). I started thinking of things to do">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/websocket-chat-server/chatroom.png">
<meta property="og:updated_time" content="2019-08-03T15:22:43.305Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WebSocket Chat Room">
<meta name="twitter:description" content="So I was just about to board my flight to Amsterdam when we were informed that the flight was to be delayed by three hours (guess what airline I was flying with..). I started thinking of things to do">
<meta name="twitter:image" content="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/websocket-chat-server/chatroom.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Stefano Lupo Tech</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">Programming, tech and other interesting things.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="http://stefanolupo.com">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://stefanolupo.com/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="page-Airport-Web-Sockets" class="article article-type-page" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2017/09/19/Airport-Web-Sockets/" class="article-date">
  <time datetime="2017-09-19T14:37:15.000Z" itemprop="datePublished">19-09-2017</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Web-Programming/">Web Programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      WebSocket Chat Room
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://s3-eu-west-1.amazonaws.com/stefano-lupo-blog-photos/websocket-chat-server/chatroom.png" alt="Websocket Chat Room"><br>So I was just about to board my flight to Amsterdam when we were informed that the flight was to be delayed by three hours (guess what airline I was flying with..). I started thinking of things to do to kill the time, but had decided not to bring my laptop with me. Fortunately however I have my router port forwarded so I have ssh access to my Raspberry Pi (which I leave on 24/7 since it uses a whole 1.2 Watts) from anywhere I have an internet connection. So I pulled out my phone and fired up JuiceSSH and started thinking what I could do..</p>
<h2 id="What-Are-WebSockets"><a href="#What-Are-WebSockets" class="headerlink" title="What Are WebSockets?"></a>What Are WebSockets?</h2><p>I had done some socket programming before (mainly writing a simple HTTP/HTTPS Proxy Server in Java  - <a href="https://github.com/stefano-lupo/Java-Proxy-Server" target="_blank" rel="external">GitHub Repo</a>) but I had heard the buzz word <em>WebSockets</em> being thrown around a lot lately so I decided to check it out. I had a rough idea of what to expect but a quick google gave me a nice succint description: </p>
<blockquote>
<p>“WebSockets represent a long awaited evolution in client/server web technology. They allow a long-held single TCP socket connection to be established between the client and server which allows for bi-directional, full duplex, messages to be instantly distributed with little overhead resulting in a very low latency connection.” - <em>from <a href="https://pusher.com/websockets" target="_blank" rel="external">pusher.com</a></em></p>
</blockquote>
<p>The first things that come to mind when reading that description are real-time applications such as video games and chat. Since I only had two hours (and was developing over SSH on my phone), I decided on the latter. Another quick google search provided a <a href="http://codular.com/node-web-sockets" target="_blank" rel="external">great blog post</a> on setting up a simple chat server with WebSockets.</p>
<h2 id="Getting-the-Required-Tools"><a href="#Getting-the-Required-Tools" class="headerlink" title="Getting the Required Tools"></a>Getting the Required Tools</h2><p>The first thing to do was to obtain a WebSocket library for node. There are a bunch of WebSocket implementations and im sure most are great, but the I went for was <em>websocket-node</em>. The first thing to do was to make a directory to hold my project. As I knew there would be server side and client side code, I made two seperate directories - <em>public</em> for client side code and <em>server</em> for server side code.</p>
<p>A quick note here - as we need to serve up the client side code (through a browser in my case), we need some extra functionality to do this for us. As I am a web developer I already had the LAMP stack set up on my machines at home (<a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-16-04" target="_blank" rel="external">this is a great article</a> on how to set this up if you haven’t already). The LAMP stack is an extremely common and easy way to serve up static websites and is most likely what was used if you have ever paid for web hosting. Another great option if you would like to stick with Node is Express. I probably would have went with this had I not already had a way to serve web pages set up. </p>
<p>I set up a new virtual host for my WebSocket chat server (<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-apache-virtual-hosts-on-ubuntu-14-04-lts" target="_blank" rel="external">see here</a>) and proceeded to create the directories to hold my chat server.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Note you may need sudo here depending on how you have set up your permissions</span></div><div class="line">$ mkdir /var/www/websockets/public /var/www/websockets/server -p</div></pre></td></tr></table></figure>
<p>The <em>-p</em> flag for mkdir is a handy one which will create any directories that do not exist along the way, saving you from typing multiple mkdir commands. </p>
<p>Next I created a package.json file in my server directory (as this will be written in node, but the client side code will not).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /var/www/websockets/server</div><div class="line">$ npm init</div></pre></td></tr></table></figure>
<p>Follow along in the initialization process to create your <em>package.json</em> file (although what you actually type has little importance). Finally install <em>websocket-node</em> using the following: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Again, either use sudo, or chown the websockets directory</span></div><div class="line">$ npm install websocket --save</div></pre></td></tr></table></figure>
<h1 id="Creating-the-WebSocket-Chat-Server"><a href="#Creating-the-WebSocket-Chat-Server" class="headerlink" title="Creating the WebSocket Chat Server"></a>Creating the WebSocket Chat Server</h1><h2 id="Server-Side-Code"><a href="#Server-Side-Code" class="headerlink" title="Server Side Code"></a>Server Side Code</h2><p>Finally it was time to write some code. I decided to work on the server side code first. The first step is to set up a standard Node HTTP server.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;&#125;);</div></pre></td></tr></table></figure></p>
<p>Next we need to specify a free port on which the server can listen. I picked 3000 as I had already portforwarded that port to my Raspberry Pi on my router. Portforwarding allows your router to forward incoming packets at the specified port, to a specified machine on your local network. It looks something like this:</p>
<p><strong><em>http://&lt;Router’s IP&gt;:3000    —&gt;    Router    —&gt;    Server on Raspberry Pi Listening on port 3000</em></strong></p>
<p>Since I had port forwarded port 3000 to point to my Raspberry Pi, the router then forwards those packets onto my Raspberry Pi allowing my server to be connected to from outside of my local network.</p>
<p>So telling our HTTP server to listen on port 3000:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Server is listening on port 3000'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Next we can create a WebSocket Server and connect it up to our HTTP server by passing the HTTP server to the constructor. This <code>WebSocket</code> is what gives us our long held client-server connection, as opposed to standard HTTP which requires a fresh HTTP request everytime we wish to update.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> WebSocketServer = <span class="built_in">require</span>(<span class="string">'websocket'</span>).server;</div><div class="line">wsServer = <span class="keyword">new</span> WebSocketServer(&#123; <span class="attr">httpServer</span>: server &#125;);</div></pre></td></tr></table></figure>
<p>Next we need some way of keeping track of our clients and the messages that have been sent. As I was just doing this for fun I didn’t implement anything fancy for storing the messages (no not even file IO - but I was doing this from my phone after all…). I ended up just storing the messages in an array which obviously isn’t a good idea, but it works in the short term.</p>
<p>So we need three variables, one to use as clients IDs, a Map to hold our clients which can be indexed by the ID and an array of sent messages.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> id = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> clients = <span class="keyword">new</span> <span class="built_in">Map</span>();</div><div class="line"><span class="keyword">var</span> messages = [];</div></pre></td></tr></table></figure>
<p>Next we define the callback to executed when a client attempts to connect to the server. Upon receiving a request, we have the option to accept or reject the client. All are welcome on my chat server so I just accepted any incoming connections. I assign the new client the next ID and increment the ID so it’s ready for the next client, add the client to our clients Map and log out a small message to the terminal so we can see when clients have joined. Finally we will send all the old messages to the newly connected client. Note that the sendUTF method obviously only works with strings, but since were using JSON, a simple <code>JSON.stringify()</code> takes care of that and the data can be recovered using <code>JSON.parse()</code> on the other side.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">wsServer.on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">request</span>) </span>&#123;</div><div class="line">    <span class="comment">// Envoked when client connects, send them all previous messages</span></div><div class="line">    <span class="keyword">var</span> connection = request.accept(<span class="string">'echo-protocol'</span>, request.origin);</div><div class="line">    connection.id = id++;</div><div class="line">    clients.set(id, connection);</div><div class="line">    <span class="built_in">console</span>.log((<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">' Connection accepted ['</span> + connection.id + <span class="string">']'</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Send old messages to client</span></div><div class="line">    connection.sendUTF(<span class="built_in">JSON</span>.stringify(messages));</div><div class="line"></div><div class="line">    <span class="comment">// More code to go here soon..</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Finally we need to define a couple more callbacks for when a client sends a message (or rather, when the server receives a message) and when the client disconnects. WebSockets make this really simple with the <code>on(&#39;message&#39;, callback)</code> and <code>on(&#39;close&#39;, callback)</code> respectively. Upon (the server) receiving a message, we want to save the message and broadcast that message to all connected clients. Ideally, we wouldn’t send this back to client who sent it and just update the sender’s client side messages, but as this was just a quick implementation, I went with the simpler route of just having the message broadcast to and picked up by all clients (including the sender). </p>
<p>Finally when a client disconnects, we free up the resources they were using and remove them from our clients Map so that we don’t try to send any more messages to that connection. This is why we used a Map, so that the client with the appropriate ID can be deleted.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">wsServer.on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">request</span>) </span>&#123;</div><div class="line">    <span class="comment">// ....Previous code</span></div><div class="line"></div><div class="line">    <span class="comment">// Envoked when a message is sent</span></div><div class="line">    connection.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> msgString = message.utf8Data;</div><div class="line">        messages.push(msgString);</div><div class="line">        sendToAllClients(msgString);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// Envoked when client disconnects</span></div><div class="line">    connection.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">reasonCode, description</span>) </span>&#123;</div><div class="line">        clients.delete(connection.id);</div><div class="line">        <span class="built_in">console</span>.log((<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">' Peer '</span> + connection.remoteAddress + <span class="string">' disconnected.'</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>The last thing to do on the server side code is to define our <code>sendToAllClients(message)</code> function. Since we have a Map containing all of our clients and a function <code>sendUTF(message)</code> to send a message to a client, this is really simple.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Note this is outside of the on request received function body</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendToAllClients</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">    clients.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">client</span>) </span>&#123;</div><div class="line">        client.sendUTF(message);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Client-Side-Code"><a href="#Client-Side-Code" class="headerlink" title="Client Side Code"></a>Client Side Code</h2><p>Now that the server is all set up its time to create the web page for the chat room. I wrote this using basic HTML, CSS, Bootstrap and jQuery. First head back to the root of our project, cd into our public folder and make two files - <em>index.html</em> and <em>script.js</em>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /var/www/websockets/public</div><div class="line">touch index.html script.js</div></pre></td></tr></table></figure>
<p>I started out with the markup to create the interface. It consists of two <code>&lt;form&gt;</code>s (one for signing up for the chat room and one for sending messages) and a <code>&lt;ul&gt;</code> to which we will programatically add <code>&lt;li&gt;</code>s as we receive messages.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"text-center"</span>&gt;</span>The Worlds Worst Chat Room <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Join The Chat Room<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"join"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">required</span> <span class="attr">placeholder</span>=<span class="string">"Enter your name"</span> <span class="attr">id</span>=<span class="string">"name"</span> <span class="attr">name</span>=<span class="string">"name"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">required</span> <span class="attr">placeholder</span>=<span class="string">"Avatar URL"</span> <span class="attr">id</span>=<span class="string">"avatar"</span> <span class="attr">name</span>=<span class="string">"avatar"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"join_button"</span> <span class="attr">id</span>=<span class="string">"join_button"</span>&gt;</span>Join<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Chat<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"chat-div"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"chatlog"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  </div><div class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"send"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">"4"</span> <span class="attr">cols</span>=<span class="string">"50"</span> <span class="attr">required</span> <span class="attr">disabled</span> <span class="attr">name</span>=<span class="string">"message"</span> <span class="attr">id</span>=<span class="string">"message"</span> <span class="attr">placeholder</span>=<span class="string">"Send a message"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-danger disabled"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"send-button"</span>&gt;</span>Send!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Finally I added some styling, grabbed CDNs for Bootstrap and jQuery and included our script.js file.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"</span>/&gt;</span><span class="undefined"></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"script.js"</span>&gt;</span><span class="undefined"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">integrity</span>=<span class="string">"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="undefined">    #chat-div &#123;</span></div><div class="line"><span class="undefined">        border: solid black 1px;</span></div><div class="line"><span class="undefined">        height:350px; </span></div><div class="line"><span class="undefined">        overflow:auto;</span></div><div class="line"><span class="undefined">        -webkit-box-shadow: 5px 5px 34px -10px rgba(0,0,0,0.75);</span></div><div class="line"><span class="undefined">        -moz-box-shadow: 5px 5px 34px -10px rgba(0,0,0,0.75);</span></div><div class="line"><span class="undefined">        box-shadow: 5px 5px 34px -10px rgba(0,0,0,0.75);</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined">    #chatlog &#123;</span></div><div class="line"><span class="undefined">        list-style-type:none; </span></div><div class="line"><span class="undefined">    </span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined">    hr &#123;</span></div><div class="line"><span class="undefined">        margin-top: 5px;</span></div><div class="line"><span class="undefined">        margin-bottom: 5px;</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined">    h4 &#123;</span></div><div class="line"><span class="undefined">        display: inline</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined">    #avatar-pic &#123;</span></div><div class="line"><span class="undefined">        width: 50px;</span></div><div class="line"><span class="undefined">        border-radius: 50%;</span></div><div class="line"><span class="undefined">        border: solid rgba(0,0,0,0.6) 1px;</span></div><div class="line"><span class="undefined">        margin: 5px;</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined">    #date-string &#123;</span></div><div class="line"><span class="undefined">        text-align: right;</span></div><div class="line"><span class="undefined">        float:right;</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined">    #message-li &#123;</span></div><div class="line"><span class="undefined">        padding:5px 0px 5px 0px</span></div><div class="line"><span class="undefined">    &#125;</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>The last thing we have to do is to connect up our client side code to our server and set up some logic in jQuery to handle the client joining the chat room and sending messages. Once the client submits the join form, we will save their inputted credentials and connect to the server. This is really easy with WebSockets, simply create a <code>new WebSocket</code> instance that points to our server. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Ensure document is defined (page is fully loaded)</span></div><div class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> ws;</div><div class="line">    <span class="keyword">var</span> name, avatar;</div><div class="line"></div><div class="line">    <span class="comment">// Allow the client to join the server </span></div><div class="line">    $(<span class="string">"#join"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params"> event </span>) </span>&#123;</div><div class="line">        event.preventDefault();</div><div class="line"></div><div class="line">        <span class="comment">// Save credentials</span></div><div class="line">        name = $(<span class="string">"#name"</span>).val();</div><div class="line">        avatar = $(<span class="string">"#avatar"</span>).val();</div><div class="line">      </div><div class="line">        <span class="comment">// Connnect to Server</span></div><div class="line">        ws =  <span class="keyword">new</span> WebSocket(<span class="string">'ws://&lt;server&gt;:&lt;port&gt;'</span>, <span class="string">'echo-protocol'</span>);</div><div class="line"></div><div class="line">        <span class="comment">// More code to go here..</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>We need to define a couple of callbacks in order to get the functionality we want. <code>onopen</code> allows us to define a callback function that will be executed when we successfully connect to the server. I wanted to announce when a new client joined the chatroom, so in the body of the <code>onopen</code> callback I created a new message object and sent that off to the server. I also enabled the <code>&lt;textarea&gt;</code> field which is used for inputing the user’s message and the submit <code>&lt;button&gt;</code> which is used for sending the message. Until this point they were both disabled as I didn’t want users attempting to send messages prior to connecting to the server.</p>
<p>We also need an event listener to handle receiving messages from the server. Once messages are received from the server, we want to create <code>&lt;li&gt;</code>s to hold the new messages. For clarity we will define this function later, so the callback just needs to call this function for each new message that is received (or array of messages in the case of the server sending the array of past messages when the client connects).<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">"#join"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params"> event </span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ...Previous code</span></div><div class="line"></div><div class="line">    <span class="comment">// Send "client" joined chatroom messgae  </span></div><div class="line">    ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> message = &#123;</div><div class="line">            name: name,</div><div class="line">            avatar: avatar,</div><div class="line">            message: <span class="string">"joined the chatroom."</span>,</div><div class="line">            date: <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">        &#125;</div><div class="line">        ws.send(<span class="built_in">JSON</span>.stringify(message));</div><div class="line"></div><div class="line">        <span class="comment">// Allow client to send messages</span></div><div class="line">        $(<span class="string">"#message"</span>).prop(<span class="string">'disabled'</span>, <span class="literal">false</span>);</div><div class="line">        $(<span class="string">"#send-button"</span>).removeClass(<span class="string">"disabled btn-danger"</span>).addClass(<span class="string">"btn-success"</span>);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Add Listener for receiving messages</span></div><div class="line">    ws.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> msg = <span class="built_in">JSON</span>.parse(e.data);</div><div class="line"></div><div class="line">        <span class="comment">// Server sends an array of passed messages to client upon joining</span></div><div class="line">        <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(msg)) &#123;</div><div class="line">            msg.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</div><div class="line">                addMessage(<span class="built_in">JSON</span>.parse(message));   </div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            addMessage(msg);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Scroll to bottom of chat div to keep up with current messages</span></div><div class="line">        $(<span class="string">'#chat-div'</span>).scrollTop($(<span class="string">'#chat-div'</span>)[<span class="number">0</span>].scrollHeight);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>Next we need a listener for sending messages to the server. This callback simply creates a message obejct, sends it on to the server and and clears the message <code>&lt;textarea&gt;</code> in preperation for the next message.</p>
<p>Finally we define the <code>addMessage(message)</code> function. We make use of jQuery’s <code>append(markup)</code> method in order to append a list item to the unordered list which holds our messages. Theres some extra bits and pieces in the markup to display the sender’s name, avatar and the timestamp.</p>
<pre><code class="js"><span class="comment">// Add listener for sending messages</span>
$(<span class="string">"#send"</span>).submit(<span class="function"><span class="keyword">function</span>(<span class="params"> event </span>) </span>{
    event.preventDefault();

    <span class="comment">// Package up the message object</span>
    <span class="keyword">var</span> message = {
        name: name,
        avatar: avatar,
        message: $(<span class="string">"#message"</span>).val(),
        date: <span class="keyword">new</span> <span class="built_in">Date</span>()
    }

    <span class="comment">// Clear the message input field once the message has been sent </span>
    $(<span class="string">"#message"</span>).val(<span class="string">''</span>);

    <span class="comment">// Send the message object (serialized as a string)</span>
    ws.send(<span class="built_in">JSON</span>.stringify(message));
});  

<span class="comment">// Some markup for the messages</span>
<span class="function"><span class="keyword">function</span> <span class="title">addMessage</span>(<span class="params">message</span>) </span>{
    $(<span class="string">"#chatlog"</span>).append(<span class="string">'&lt;li id="message-li"&gt;'</span>
        + <span class="string">'&lt;div&gt;&lt;img id="avatar-pic" src="'</span>
        + <span class="string">"  "</span> + message.avatar + <span class="string">'"&gt;'</span> 
        + <span class="string">"&lt;h4&gt;"</span> + message.name + <span class="string">"&lt;/h4&gt;"</span>
        + <span class="string">'&lt;p id="date-string"&gt;'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>(message.date).toLocaleTimeString() + <span class="string">"&lt;/p&gt;&lt;/div&gt;"</span> 
        + message.message 
        + <span class="string">"&lt;hr&gt;"</span>   
        + <span class="string">"&lt;/li&gt;"</span>
    );
}
</code></pre>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>And with that we’re all set. Run the server code with <code>node server/index.js</code> from the root of our project directory and browse to your IP address (or localhost if you’re developing locally) and give it a go!</p>
<p>The full source code is available <a href="https://github.com/stefano-lupo/websocket-chat-server" target="_blank" rel="external">here on GitHub</a>. Thanks for reading.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://stefanolupo.com/blog/2017/09/19/Airport-Web-Sockets/" data-id="cjyvuavpk0000ln8q7ay5irjn" class="article-share-link">Share</a>
      
        <a href="http://stefanolupo.com/blog/2017/09/19/Airport-Web-Sockets/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebSockets-Node-Javascript-SSH-Raspberry-Pi/">WebSockets Node Javascript SSH Raspberry Pi</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2017/10/17/GameOfLife/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          John Conway&#39;s Game of Life in Processing
        
      </div>
    </a>
  
  
    <a href="/blog/2017/09/02/hexagonPatioTable/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Octagonal Patio Table</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Web-Programming/">Web Programming</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Woodworking/">Woodworking</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2017/10/17/GameOfLife/">John Conway&#39;s Game of Life in Processing</a>
          </li>
        
          <li>
            <a href="/blog/2017/09/19/Airport-Web-Sockets/">WebSocket Chat Room</a>
          </li>
        
          <li>
            <a href="/blog/2017/09/02/hexagonPatioTable/">Octagonal Patio Table</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Stefano Lupo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="http://stefanolupo.com" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'stefanolupo-tech';
  
  var disqus_url = 'http://stefanolupo.com/blog/2017/09/19/Airport-Web-Sockets/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/blog/js/script.js"></script>

  </div>
</body>
</html>